<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parcul Auto</title>

  <link rel="stylesheet" href="assets/css/style.css">
  <script defer src="assets/js/lang.js"></script>

  <style>
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{
      background:#0c1734;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;
      border-bottom:2px solid var(--primary);box-shadow:0 0 24px rgba(0,229,255,.35) inset;position:sticky;top:0;z-index:5
    }
    .logo-left img{height:40px;filter:drop-shadow(0 0 10px rgba(0,229,255,.35))}
    nav button{background:transparent;border:1px solid var(--primary);color:var(--text);margin-left:10px;padding:6px 14px;border-radius:8px;cursor:pointer}
    nav button:hover{background:var(--primary);color:#001329}

    .container{max-width:1180px;margin:0 auto;padding:24px 16px;text-align:center}
    h1{margin:8px 0 6px;text-shadow:0 0 18px rgba(0,229,255,.35)}
    p.sub{opacity:.85;margin:0}

    .car-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px;margin-top:26px;text-align:left}
    .car-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35);transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .car-card:hover{transform:translateY(-2px);border-color:var(--primary);box-shadow:0 12px 28px rgba(0,0,0,.45)}
    .thumb{padding-top:62%;background-size:cover;background-position:center}
    .card-body{padding:14px 16px}
    .car-card h3{margin:4px 0 8px}
    .car-card .price{font-weight:700;color:var(--primary);margin-top:4px}
    .car-card .cons{opacity:.95;margin-top:4px}

    .btn{display:inline-block;cursor:pointer;border-radius:10px;padding:10px 14px;border:1px solid var(--primary);color:var(--text);background:transparent}
    .btn.primary{background:var(--primary);color:#001329;border-color:var(--primary);font-weight:600}
    .btn.primary:hover{filter:brightness(1.07)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px}

    .cal{margin:14px 16px 16px;border-top:1px solid var(--border);padding-top:12px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
    .cal h4{margin:8px 0 0}
    .cal .cell{text-align:center;padding:8px 0;border:1px solid var(--border);border-radius:8px;font-size:.95rem;background:rgba(255,255,255,.02)}
    .cal .muted{opacity:.45}
    .cal .busy{background:rgba(255,46,77,.18);border-color:rgba(255,46,77,.45)}
    .cal-legend{display:flex;gap:12px;align-items:center;margin-top:8px;opacity:.9;font-size:.9rem}
    .dot{display:inline-block;width:12px;height:12px;border-radius:3px;border:1px solid var(--border);background:rgba(255,255,255,.06);margin-right:6px}
    .dot.busy{background:rgba(255,46,77,.4);border-color:rgba(255,46,77,.6)}

    footer{margin-top:36px;padding:18px;border-top:1px solid var(--border);text-align:center;opacity:.8}

    /* Modal booking */
    .modal[hidden]{display:none}
    .modal{position:fixed;inset:0;z-index:50}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
    .modal-card{
      position:relative;max-width:520px;margin:8vh auto 0;background:var(--panel, #0f1d3d);
      border:1px solid var(--border, rgba(255,255,255,.12));border-radius:14px;
      box-shadow:0 30px 80px rgba(0,0,0,.55);padding:18px 16px 16px;color:var(--text)
    }
    .modal-card h3{margin:0 0 6px}
    .modal-x{
      position:absolute;right:10px;top:8px;border:1px solid var(--border);
      background:transparent;color:var(--text);border-radius:8px;cursor:pointer;width:32px;height:32px
    }
    .form label{display:block;margin:8px 0}
    .form input,.form textarea{
      width:100%;background:transparent;border:1px solid var(--border);
      border-radius:10px;color:var(--text);padding:10px 12px
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){ .row2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="logo-left"><img src="assets/img/logo.png" alt="Logo"></div>
    <nav>
      <button data-lang="ro">RO</button>
      <button data-lang="ru">RU</button>
      <button data-lang="en">EN</button>
    </nav>
  </header>

  <div class="container">
    <h1 data-i18n="title">Parcul Auto</h1>
    <p class="sub" data-i18n="subtitle">Autoturisme disponibile pentru închiriere chiar acum</p>
    <div id="car-list" class="car-list"></div>
  </div>

  <footer>© 2025 Auto Rent Chișinău • Toate drepturile rezervate</footer>

  <!-- Modal Booking -->
  <div id="booking-modal" class="modal" hidden>
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card">
      <button class="modal-x" data-close="1">×</button>
      <h3 id="bm-title" data-i18n="book_title">Rezervare</h3>
      <p class="muted" id="bm-car"></p>

      <form id="booking-form" class="form">
        <input type="hidden" name="car_id" id="bm-car-id">
        <input type="hidden" name="car" id="bm-car-name">

        <div class="row2">
          <label>
            <span data-i18n="f_name">Nume</span>
            <input name="name" required>
          </label>
          <label>
            <span data-i18n="f_phone">Telefon</span>
            <input name="phone" required>
          </label>
        </div>

        <div class="row2">
          <label>
            <span data-i18n="f_from">Data start</span>
            <input name="date_from" type="date" required>
          </label>
          <label>
            <span data-i18n="f_to">Data sfârșit</span>
            <input name="date_to" type="date" required>
          </label>
        </div>

        <label>
          <span data-i18n="f_comment">Comentariu</span>
          <textarea name="comment" rows="3"></textarea>
        </label>

        <div class="actions">
          <button type="button" class="btn" data-close="1" data-i18n="btn_cancel">Anulează</button>
          <button type="submit" class="btn primary" data-i18n="btn_send">Trimite</button>
        </div>

        <div id="bm-status" class="muted" style="margin-top:8px"></div>
      </form>
    </div>
  </div>

  <script>
    /* ===== i18n ===== */
    const I18N = {
      ro:{ title:"Parcul Auto", subtitle:"Autoturisme disponibile pentru închiriere chiar acum",
           year:"Anul", gearbox:"Cutie", fuel:"Combustibil", price:"Preț", per_day:"€/zi",
           book:"Rezervă", consumption:"Consum (oraș/șosea)",
           empty:"Nu sunt mașini disponibile momentan.", load_error:"Nu s-a putut încărca parcul auto.",
           cal_free:"Liber", cal_busy:"Ocupat", weekdays:["Lu","Ma","Mi","Jo","Vi","Sa","Du"], locale:"ro-RO",
           book_title:"Rezervare", f_name:"Nume", f_phone:"Telefon", f_from:"Data start", f_to:"Data sfârșit",
           f_comment:"Comentariu", btn_cancel:"Anulează", btn_send:"Trimite",
           sent:"Trimis! Mulțumim.", saved:"Salvat!", err:"Nu s-a putut trimite. Încercați din nou."
      },
      ru:{ title:"Автопарк", subtitle:"Автомобили доступны к аренде прямо сейчас",
           year:"Год", gearbox:"КПП", fuel:"Топливо", price:"Цена", per_day:"€/сут",
           book:"Забронировать", consumption:"Расход (город/трасса)",
           empty:"Сейчас нет доступных автомобилей.", load_error:"Не удалось загрузить автопарк.",
           cal_free:"Свободно", cal_busy:"Занято", weekdays:["Пн","Вт","Ср","Чт","Пт","Сб","Вс"], locale:"ru-RU",
           book_title:"Бронирование", f_name:"Имя", f_phone:"Телефон", f_from:"Дата начала", f_to:"Дата окончания",
           f_comment:"Комментарий", btn_cancel:"Отмена", btn_send:"Отправить",
           sent:"Заявка отправлена! Спасибо.", saved:"Сохранено!", err:"Не удалось отправить. Попробуйте ещё раз."
      },
      en:{ title:"Car Fleet", subtitle:"Cars available for rent right now",
           year:"Year", gearbox:"Transmission", fuel:"Fuel", price:"Price", per_day:"€/day",
           book:"Reserve", consumption:"Consumption (city/highway)",
           empty:"No cars available at the moment.", load_error:"Could not load the fleet.",
           cal_free:"Free", cal_busy:"Busy", weekdays:["Mo","Tu","We","Th","Fr","Sa","Su"], locale:"en-US",
           book_title:"Reservation", f_name:"Name", f_phone:"Phone", f_from:"Start date", f_to:"End date",
           f_comment:"Comment", btn_cancel:"Cancel", btn_send:"Send",
           sent:"Sent! Thank you.", saved:"Saved!", err:"Could not send. Please try again."
      }
    };
    const LANG = (localStorage.getItem('lang') || document.documentElement.lang || 'ro').toLowerCase();
    const T = k => (I18N[LANG] && I18N[LANG][k]) || I18N.ro[k] || k;
    const LOCALE = (I18N[LANG] && I18N[LANG].locale) || 'ro-RO';
    const WDAYS = (I18N[LANG] && I18N[LANG].weekdays) || I18N.ro.weekdays;
    function applyStaticI18N(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(k) el.textContent=T(k); }); }
    applyStaticI18N();

    /* ===== helpers ===== */
    const lang = LANG;
    const safe = v => (v==null ? '' : String(v));
    function pick(obj, fallback=''){
      if(obj==null) return fallback||'';
      if(typeof obj==='string' || typeof obj==='number') return String(obj);
      if(typeof obj==='object'){
        const order=[lang,'ro','ru','en'];
        for(const k of order){
          const v=obj[k];
          if(typeof v==='string' || typeof v==='number') return String(v);
          if(v && typeof v==='object'){
            const vv = Object.values(v).find(x=>typeof x==='string' || typeof x==='number');
            if(vv!=null) return String(vv);
          }
        }
        const first = Object.values(obj).find(x=>typeof x==='string' || typeof x==='number');
        if(first!=null) return String(first);
      }
      return fallback||'';
    }
    function firstImage(images){
      if(!images) return '';
      if(Array.isArray(images)) return images.find(u=>!!u) || '';
      if(typeof images==='string') return images;
      return '';
    }

    /* ===== sources (не трогаем) ===== */
    const DATA_URL = 'data/cars.json';
    const BOOK_URL = 'data/bookings.json';

    /* ===== calendar ===== */
    let BOOKINGS = {};
    async function loadBookings(){
      BOOKINGS = {};
      try{
        const r = await fetch(BOOK_URL + '?v=' + Date.now(), {cache:'no-store'});
        if(!r.ok) return;
        const j = await r.json();
        const arr = Array.isArray(j?.bookings) ? j.bookings : (Array.isArray(j) ? j : []);
        arr.forEach(b=>{
          const id = b.car_id || b.carId || b.car || b.id;
          if(!id) return;
          if(!BOOKINGS[id]) BOOKINGS[id] = new Set();
          if(b.dates && Array.isArray(b.dates)){
            b.dates.forEach(d => BOOKINGS[id].add(String(d).slice(0,10)));
          }else if(b.date_from && b.date_to){
            const from = new Date(b.date_from), to = new Date(b.date_to);
            for(let dt=new Date(from); dt<=to; dt.setDate(dt.getDate()+1)){
              BOOKINGS[id].add(dt.toISOString().slice(0,10));
            }
          }
        });
      }catch(e){}
    }
    function renderCalendar(carId, mount){
      const busy = BOOKINGS[carId] || new Set();
      const now = new Date();
      const months = [ new Date(now.getFullYear(), now.getMonth(), 1),
                       new Date(now.getFullYear(), now.getMonth()+1, 1) ];
      const fmtMonth = d => d.toLocaleDateString(LOCALE, {month:'long', year:'numeric'});

      const monthHTML = (firstDay) => {
        const y = firstDay.getFullYear(), m = firstDay.getMonth();
        const start = new Date(y, m, 1), end = new Date(y, m+1, 0);
        const head = WDAYS.map(d=>`<div class="cell muted"><b>${d}</b></div>`).join('');
        let pad = (start.getDay()+6)%7; const cells = [];
        for(let i=0;i<pad;i++) cells.push('<div class="cell muted"></div>');
        for(let d=1; d<=end.getDate(); d++){
          const day = new Date(y, m, d), iso = day.toISOString().slice(0,10);
          cells.push(`<div class="cell ${busy.has(iso)?'busy':''}">${d}</div>`);
        }
        return `<div class="cal-block">
          <h4 style="text-transform:capitalize">${fmtMonth(firstDay)}</h4>
          <div class="cal-grid">${head}${cells.join('')}</div>
        </div>`;
      };

      mount.innerHTML = `
        <div class="cal">
          ${months.map(monthHTML).join('')}
          <div class="cal-legend">
            <span><span class="dot"></span> ${T('cal_free')}</span>
            <span><span class="dot busy"></span> ${T('cal_busy')}</span>
          </div>
        </div>`;
    }

    /* ===== card ===== */
    function cardHTML(c){
      const title = pick(c.name, '—');
      const desc  = pick(c.description, '');
      const img   = firstImage(c.images);
      const price = c.price_per_day ? `<div class="price">${safe(c.price_per_day)} ${T('per_day')}</div>` : '';
      const cons  = (c.consumption_city || c.consumption_hwy)
        ? `<div class="cons"><b>${T('consumption')}:</b> ${safe(c.consumption_city||'?')} / ${safe(c.consumption_hwy||'?')} l/100km</div>`
        : '';

      let gallery = '';
      if (Array.isArray(c.images) && c.images.length){
        gallery = c.images.filter(Boolean).map(u => `<img src="${u}" alt="${title}" style="width:100%;display:block">`).join('');
      }

      return `
        <article class="car-card" data-id="${safe(c.id)}">
          <div class="thumb" style="${img ? `background-image:url('${img}')` : ''}"></div>
          <div class="card-body">
            <h3>${title}</h3>
            ${desc ? `<p class="muted">${desc}</p>` : ''}
            ${c.year ? `<p><b>${T('year')}:</b> ${safe(c.year)}</p>` : ''}
            ${c.transmission ? `<p><b>${T('gearbox')}:</b> ${safe(c.transmission)}</p>` : ''}
            ${c.fuel ? `<p><b>${T('fuel')}:</b> ${safe(c.fuel)}</p>` : ''}
            ${price}
            ${cons}
            <div class="actions">
              <button class="btn primary book-btn"
                      data-id="${safe(c.id)}"
                      data-name="${title}">${T('book')}</button>
            </div>
          </div>
          <div class="cal-mount"></div>
          ${gallery}
        </article>
      `;
    }

    async function loadCars(){
      const list = document.getElementById('car-list');
      try{
        await loadBookings();
        const r = await fetch(DATA_URL + '?v=' + Date.now(), { cache:'no-store' });
        const j = await r.json();
        const cars = Array.isArray(j?.cars) ? j.cars : [];
        list.innerHTML = cars.length ? cars.map(cardHTML).join('') : `<p style="opacity:.8">${T('empty')}</p>`;

        document.querySelectorAll('.car-card').forEach(card=>{
          const id = card.getAttribute('data-id');
          const mount = card.querySelector('.cal-mount');
          if(id && mount) renderCalendar(id, mount);
        });

        bindBookButtons();
      }catch(e){
        console.error(e);
        list.innerHTML = `<p style="opacity:.8">${T('load_error')}</p>`;
      }
    }

    document.querySelectorAll('[data-lang]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ localStorage.setItem('lang', btn.dataset.lang); location.reload(); });
    });

    /* ===== modal booking ===== */
    const modal = document.getElementById('booking-modal');
    const form  = document.getElementById('booking-form');
    const carEl = document.getElementById('bm-car');
    const carIdEl = document.getElementById('bm-car-id');
    const carNameEl = document.getElementById('bm-car-name');
    const statusEl = document.getElementById('bm-status');

    document.querySelectorAll('#booking-modal [data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n'); if(k) el.textContent = T(k);
    });

    function openBooking({id, title}){
      carIdEl.value = id || '';
      carNameEl.value = title || '';
      carEl.textContent = title ? `• ${title}` : '';
      statusEl.textContent = '';
      modal.hidden = false; document.body.style.overflow = 'hidden';
    }
    function closeBooking(){
      modal.hidden = true; document.body.style.overflow = ''; form.reset();
    }
    modal.addEventListener('click', (e)=>{ if(e.target.dataset.close) closeBooking(); });

    function bindBookButtons(){
      document.querySelectorAll('.book-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          openBooking({ id: btn.getAttribute('data-id'), title: btn.getAttribute('data-name') });
        });
      });
    }

    async function postTo(fn, payload){
      const r = await fetch(`/.netlify/functions/${fn}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(j.error || r.status);
      return j;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const payload = {
        car_id:   fd.get('car_id'),
        car:      fd.get('car'),
        name:     fd.get('name'),
        phone:    fd.get('phone'),
        date_from:fd.get('date_from'),
        date_to:  fd.get('date_to'),
        comment:  fd.get('comment') || ''
      };

      form.querySelectorAll('button').forEach(b=> b.disabled = true);
      statusEl.textContent = '...';

      try{
        await postTo('save-client', payload);   // CRM (clients.json)
        await postTo('save-booking', payload);  // Calendar (bookings.json)

        statusEl.textContent = T('saved');

        await loadBookings();
        const card = document.querySelector(`.car-card[data-id="${payload.car_id}"]`);
        if(card){
          const mount = card.querySelector('.cal-mount');
          if(mount) renderCalendar(payload.car_id, mount);
        }
        setTimeout(closeBooking, 900);
      }catch(err){
        console.error(err);
        statusEl.textContent = T('err');
      }finally{
        form.querySelectorAll('button').forEach(b=> b.disabled = false);
      }
    });

    loadCars();
  </script>
</body>
</html>

   