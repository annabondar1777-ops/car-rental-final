<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Автопарк — Auto Rent</title>

  <!-- твои стили сайта -->
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/typography.css">
  <link rel="stylesheet" href="assets/css/components.css">

  <style>
    /* Небольшие локальные стили для карточек и модалки */
    .fleet-wrap{max-width:1200px;margin:0 auto;padding:24px}
    .grid-cars{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
    .car{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
    .car .img{aspect-ratio:16/10;object-fit:cover;width:100%}
    .car .body{padding:14px}
    .row{display:flex;gap:10px;align-items:center}
    .space{justify-content:space-between}
    .muted{opacity:.8;font-size:.9rem}
    .price{font-weight:700}
    .btn{cursor:pointer;border:1px solid rgba(255,255,255,.2);background:transparent;padding:10px 14px;border-radius:10px}
    .btn.primary{background:linear-gradient(90deg,#00d4ff,#0066ff);border-color:transparent;color:#fff}
    .bad{color:#ff6a6a}
    dialog{border:none;border-radius:16px;max-width:640px;width:92%;padding:0;background:rgba(10,18,35,.98);color:#fff}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    .modal-head{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-body{padding:18px}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modal-grid label{display:flex;flex-direction:column;gap:6px}
    .modal-grid input,.modal-grid textarea{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:transparent;color:inherit}
    .modal-foot{display:flex;gap:10px;justify-content:flex-end;padding:14px 18px;border-top:1px solid rgba(255,255,255,.08)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:.8rem;opacity:.9;border:1px dashed rgba(255,255,255,.25);padding:4px 8px;border-radius:999px}
  </style>
</head>
<body>

<header class="site-header">
  <!-- твоя шапка (логотип/меню) если нужна — оставь как на остальных страницах -->
</header>

<main class="fleet-wrap">

  <div class="row space" style="margin-bottom:16px">
    <h1 style="margin:0">Автопарк</h1>
    <div class="muted">Нажмите «Забронировать» у нужного авто</div>
  </div>

  <div id="cars" class="grid-cars" aria-live="polite"></div>

  <!-- ======== Модалка бронирования ======== -->
  <dialog id="bookModal">
    <div class="modal-head row space">
      <div>
        <div class="muted" id="bm-car-name">Авто</div>
        <div class="muted" id="bm-booked" style="margin-top:4px"></div>
      </div>
      <button class="btn" onclick="bookModal.close()">✕</button>
    </div>

    <form id="bookForm" class="modal-body" method="dialog">
      <input type="hidden" name="car_id" id="bm-car-id">
      <input type="hidden" name="car" id="bm-car-title">

      <div class="modal-grid">
        <label>Имя
          <input name="name" required placeholder="Ваше имя">
        </label>
        <label>Телефон
          <input name="phone" required placeholder="+373 ...">
        </label>
        <label>Email
          <input name="email" type="email" placeholder="you@example.com">
        </label>
        <label>Дата начала
          <input name="date_from" id="bm-date-from" type="date" required>
        </label>
        <label>Дата конца
          <input name="date_to" id="bm-date-to" type="date" required>
        </label>
        <label style="grid-column:1/-1">Комментарий
          <textarea name="comment" rows="3" placeholder="Пожелания/время подачи"></textarea>
        </label>
      </div>

      <div class="badges" style="margin-top:12px">
        <span class="badge">Бронь без предоплаты</span>
        <span class="badge">Подтверждение в админке</span>
      </div>

      <div id="bm-msg" class="muted" style="margin-top:10px"></div>
    </form>

    <div class="modal-foot">
      <button class="btn" onclick="bookModal.close()">Отмена</button>
      <button class="btn primary" form="bookForm" type="submit">Отправить заявку</button>
    </div>
  </dialog>

</main>

<footer class="site-footer">
  <!-- твой футер -->
</footer>

<script>
/* ===== Утилиты ===== */
const esc = s => String(s ?? '').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const d10 = s => { if(!s) return ''; const d=new Date(s); return isNaN(+d)?String(s).slice(0,10):d.toISOString().slice(0,10); };

/* ===== Данные авто =====
   Ожидается файл /data/cars.json (как и раньше).
   Поля: id, name, year, transmission, fuel, price_per_day, images[0], description.
*/
async function loadCars(){
  const r = await fetch('data/cars.json',{cache:'no-store'});
  if(!r.ok) throw new Error('Не удалось загрузить список авто');
  return await r.json();
}

/* ===== Рендер карточек ===== */
function carCard(c){
  const img = (c.images && c.images[0]) || 'images/placeholder.jpg';
  return `
    <article class="car">
      <img class="img" src="${esc(img)}" alt="${esc(c.name||'car')}">
      <div class="body">
        <div class="row space">
          <h3 style="margin:0">${esc(c.name||'Авто')}</h3>
          <div class="price">${esc(c.price_per_day || '')} €/день</div>
        </div>
        <div class="muted" style="margin:.25rem 0 0.5rem">${esc(c.description || '')}</div>
        <div class="row muted" style="flex-wrap:wrap">
          <span>Год: ${esc(c.year || '—')}</span>
          <span style="opacity:.4">|</span>
          <span>КПП: ${esc(c.transmission || '—')}</span>
          <span style="opacity:.4">|</span>
          <span>Топливо: ${esc(c.fuel || '—')}</span>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" data-book data-id="${esc(c.id)}" data-title="${esc(c.name||'')}" >Забронировать</button>
        </div>
      </div>
    </article>
  `;
}

async function renderCars(){
  try{
    const cars = await loadCars();
    const wrap = document.getElementById('cars');
    wrap.innerHTML = (cars||[]).map(carCard).join('');

    // навешиваем обработчик на кнопки "Забронировать"
    wrap.querySelectorAll('[data-book]').forEach(btn=>{
      btn.addEventListener('click', () => openBooking(btn.dataset.id, btn.dataset.title));
    });
  }catch(e){
    document.getElementById('cars').innerHTML = `<div class="bad">Ошибка: ${esc(e.message)}</div>`;
  }
}

/* ===== Модалка брони ===== */
const bookModal = document.getElementById('bookModal');

async function openBooking(carId, carTitle){
  // заполняем шапку модалки
  document.getElementById('bm-car-id').value = carId;
  document.getElementById('bm-car-title').value = carTitle;
  document.getElementById('bm-car-name').textContent = carTitle || ('Авто '+carId);
  document.getElementById('bm-msg').textContent = '';

  // загрузим все брони, отфильтруем по этому авто, покажем занятые диапазоны
  try{
    const r = await fetch('/.netlify/functions/cal-list');
    const j = await r.json();
    const booked = (j.bookings||[]).filter(b => String(b.car_id||'') === String(carId));
    if(booked.length){
      const txt = booked.map(b => `${d10(b.date_from)}→${d10(b.date_to)}`).join(', ');
      document.getElementById('bm-booked').innerHTML = `<span class="muted">Занято: ${esc(txt)}</span>`;
    }else{
      document.getElementById('bm-booked').textContent = 'Свободно';
    }
  }catch{ document.getElementById('bm-booked').textContent = ''; }

  bookModal.showModal();
}

/* отправка формы */
document.getElementById('bookForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const data = Object.fromEntries(fd.entries());

  // валидация диапазона дат
  if(new Date(data.date_from) > new Date(data.date_to)){
    document.getElementById('bm-msg').textContent = 'Дата по должна быть позже даты с';
    return;
  }

  document.getElementById('bm-msg').textContent = 'Отправляем...';

  try{
    const r = await fetch('/.netlify/functions/cal-update', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(data)
    });
    const j = await r.json();
    if(j.ok){
      document.getElementById('bm-msg').textContent = 'Заявка отправлена! Менеджер свяжется с вами.';
      setTimeout(()=>bookModal.close(), 900);
      e.target.reset();
    }else{
      document.getElementById('bm-msg').textContent = 'Ошибка: ' + (j.error||'не удалось отправить');
    }
  }catch(err){
    document.getElementById('bm-msg').textContent = 'Сеть недоступна. Попробуйте позже.';
  }
});

/* старт */
renderCars();
</script>

</body>
</html>
