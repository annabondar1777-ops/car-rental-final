<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äî Auto</title>
  <link rel="stylesheet" href="assets/css/admin.css">
</head>
<body>
<header class="header">
  <div class="brand"><img src="assets/img/logo.png" alt="Logo"></div>
  <nav class="nav">
    <div id="lang-switch" class="row">
      <button class="btn" data-lang="ru">RU</button>
      <button class="btn" data-lang="ro">RO</button>
      <button class="btn" data-lang="en">EN</button>
    </div>
    <button class="btn tab-btn" data-tab="cars">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</button>
    <button class="btn tab-btn" data-tab="crm">CRM</button>
    <button class="btn tab-btn" data-tab="booking">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    <button class="btn tab-btn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="btn tab-btn" data-tab="notify">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
  </nav>
</header>

<main>

<!-- ====================== CARS ====================== -->
<section id="tab-cars" class="tab active">
  <form id="car-form" class="card">
    <div class="grid2">
      <div>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ<input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></label>
        <label>–û–ø–∏—Å–∞–Ω–∏–µ<textarea name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ"></textarea></label>
        <label>–ì–æ–¥ <input name="year" placeholder="2021"></label>
        <label>–ö–ü–ü <input name="transmission" placeholder="Automat / Manual"></label>
        <label>–¢–æ–ø–ª–∏–≤–æ <input name="fuel" placeholder="BenzinƒÉ / Diesel"></label>
        <label>–¶–µ–Ω–∞/—Å—É—Ç–∫–∏ <input name="price_per_day" placeholder="100"></label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" name="bookable" checked> –£—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        </label>
      </div>
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <input id="file-input" type="file" accept="image/*" multiple capture="environment" style="display:none">
          <button class="btn" type="button" id="btn-pick">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
          <button class="btn" type="button" id="btn-upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Å–∞–π—Ç</button>
          <span class="muted" id="upload-msg"></span>
        </div>
        <label>–§–æ—Ç–æ (URL, –ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ)
          <textarea id="car-images" name="images" rows="8" placeholder="https://...jpg"></textarea>
        </label>
        <div id="images-preview" class="grid-img"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="car-add" type="button">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
      <button class="btn primary" id="car-save" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </form>

  <div class="card">
    <div class="row space">
      <h3>–°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h3>
      <div id="publish_status" class="muted"></div>
    </div>
    <table class="table">
      <thead>
        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ì–æ–¥</th><th>–ö–ü–ü</th><th>–¢–æ–ø–ª–∏–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr>
      </thead>
      <tbody id="cars-list"></tbody>
    </table>
  </div>
</section>

<!-- ====================== CRM ====================== -->
<section id="tab-crm" class="tab">
  <div class="card">
    <h3>CRM ‚Äî –ó–∞—è–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <form id="crm-form">
      <div class="grid2">
        <div>
          <label>–ò–º—è<input name="name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required></label>
          <label>–¢–µ–ª–µ—Ñ–æ–Ω<input name="phone" placeholder="+373 ..." required></label>
          <label>Email<input name="email" placeholder="client@example.com"></label>
          <label>–ê–≤—Ç–æ–º–æ–±–∏–ª—å<input name="car" placeholder="BMW X5"></label>
        </div>
        <div>
          <label>–î–∞—Ç–∞ —Å<input name="date_from" type="date"></label>
          <label>–î–∞—Ç–∞ –ø–æ<input name="date_to" type="date"></label>
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π<textarea name="comment" rows="4" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞"></textarea></label>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        <span class="muted" id="crm-status"></span>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="row space" style="gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">–ó–∞—è–≤–∫–∏</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <input id="crm-search" placeholder="–ü–æ–∏—Å–∫: –∏–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"
               style="width:280px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background:transparent;color:inherit">
        <button id="crm-refresh" class="btn" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="crm-add" class="btn" type="button">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
        <button id="crm-export" class="btn" type="button">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>
    </div>

    <table id="crm-table" class="table" style="width:100%">
      <thead>
        <tr>
          <th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>Email</th><th>–ê–≤—Ç–æ</th>
          <th>–°</th><th>–ü–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- ====================== BOOKING (Calendar admin) ====================== -->
<section id="tab-booking" class="tab">
  <div class="card">
    <div class="row space" style="gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</h3>
      <button id="cal-add" class="btn primary" type="button">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
      <span class="muted" id="bk-status"></span>
    </div>

    <table id="cal-table" class="table" style="width:100%">
      <thead>
        <tr>
          <th>–ò–º—è</th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>–ê–≤—Ç–æ (ID/–ù–∞–∑–≤–∞–Ω–∏–µ)</th>
          <th>–°</th>
          <th>–ü–æ</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th style="white-space:nowrap">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- ====================== SETTINGS ====================== -->
<section id="tab-settings" class="tab">
  <div class="card">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</h3>
    <form id="settings-form">
      <div class="grid2">
        <div>
          <label>–ë—Ä–µ–Ω–¥<input name="brand" placeholder="Auto Rent"></label>
          <label>–°–ª–æ–≥–∞–Ω (RO)<input name="slogan_ro" placeholder="chirii auto"></label>
          <label>–°–ª–æ–≥–∞–Ω (RU)<input name="slogan_ru" placeholder="–ø—Ä–æ–∫–∞—Ç –∞–≤—Ç–æ"></label>
          <label>–°–ª–æ–≥–∞–Ω (EN)<input name="slogan_en" placeholder="car rental"></label>
        </div>
        <div>
          <label>–¢–µ–ª–µ—Ñ–æ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π<input name="phone_main" placeholder="+373 ..."></label>
          <label>–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ø.<input name="phone_alt" placeholder="+373 ..."></label>
          <label>Instagram<input name="instagram_link" placeholder="https://instagram.com/..."></label>
          <label>WhatsApp<input name="whatsapp_link" placeholder="https://wa.me/373..."></label>
          <label>Telegram<input name="telegram_link" placeholder="https://t.me/..."></label>
          <label>Viber<input name="viber_link" placeholder="viber://chat?number=+373..."></label>
          <label>Email<input name="email" placeholder="info@example.com"></label>
          <label>–ê–¥—Ä–µ—Å<input name="address" placeholder="str. ..."></label>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" id="settings-save" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <span class="muted" id="settings-status"></span>
      </div>
    </form>
  </div>
</section>

<!-- ====================== NOTIFY ====================== -->
<section id="tab-notify" class="tab">
  <div class="card">
    <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
    <form id="notify-form">
      <div class="grid2">
        <div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" name="email_enabled" checked> –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ email
          </label>
          <label>Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            <input name="email_to" placeholder="you@example.com" value="paulacerniciuc@gmail.com">
          </label>
        </div>
        <div class="muted">
          –ü–∏—Å—å–º–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—Ä–∏ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö –∏ –±—Ä–æ–Ω—è—Ö. 
          –ù–∞ Netlify –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: <b>RESEND_API_KEY</b>, <b>ADMIN_EMAIL</b>, <b>SITE_URL</b>.
        </div>
      </div>
      <div class="row">
        <button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        <span class="muted" id="notify-status"></span>
      </div>
    </form>
  </div>
</section>

</main>

<script src="assets/js/admin.js"></script>

<script>
/* ===== helpers ===== */
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
const d10 = s => { if(!s) return ''; const d=new Date(s); return isNaN(+d)?String(s).slice(0,10):d.toISOString().slice(0,10); };

/* =====================================================
   CRM (list from /data/clients.json, save via functions)
   ===================================================== */
const CRM_STATUSES = [
  { v:'new', t:'–ù–æ–≤–∞—è' }, { v:'in_progress', t:'–í —Ä–∞–±–æ—Ç–µ' },
  { v:'confirmed', t:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞' }, { v:'cancelled', t:'–û—Ç–º–µ–Ω–µ–Ω–∞' }, { v:'done', t:'–ó–∞–≤–µ—Ä—à–µ–Ω–∞' }
];

let crmAll = [];

async function crmLoad(){
  try{
    // —á–∏—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é JSON –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
    const r = await fetch('/data/clients.json', { cache: 'no-store' });
    const j = await r.json();
    crmAll = Array.isArray(j) ? j : (j.clients || []);
    renderCRMTable(crmAll);
  }catch(e){
    console.error('crmLoad', e);
    document.querySelector('#crm-status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CRM';
  }
}

function crmRowHTML(c){
  const opts = CRM_STATUSES.map(s => `<option value="${s.v}" ${c.status===s.v?'selected':''}>${s.t}</option>`).join('');
  return `
    <tr data-id="${esc(c.id||'')}">
      <td><input value="${esc(c.name||'')}"></td>
      <td><input value="${esc(c.phone||'')}"></td>
      <td><input value="${esc(c.email||'')}"></td>
      <td><input value="${esc(c.cars||c.car||'')}"></td>
      <td><input type="date" value="${d10(c.date_from)}"></td>
      <td><input type="date" value="${d10(c.date_to)}"></td>
      <td><select class="crm-status">${opts}</select></td>
      <td><input value="${esc(c.comment||'')}"></td>
      <td style="white-space:nowrap">
        <button class="btn" data-action="save">üíæ</button>
        <button class="btn" data-action="delete">üóëÔ∏è</button>
      </td>
    </tr>`;
}

function readCrmRow(tr){
  const t=tr.querySelectorAll('td');
  return {
    id: tr.dataset.id || (Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6)),
    name: t[0].querySelector('input').value.trim(),
    phone: t[1].querySelector('input').value.trim(),
    email: t[2].querySelector('input').value.trim(),
    car: t[3].querySelector('input').value.trim(),
    date_from: t[4].querySelector('input').value,
    date_to: t[5].querySelector('input').value,
    status: t[6].querySelector('select').value,
    comment: t[7].querySelector('input').value.trim()
  };
}

function renderCRMTable(items){
  const tbody = document.querySelector('#crm-table tbody');
  if(!tbody) return;
  tbody.innerHTML = items.map(crmRowHTML).join('');

  // SAVE
  tbody.querySelectorAll('[data-action="save"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr');
    const data = readCrmRow(tr);
    let ok=false, code=0;

    // –æ—Å–Ω–æ–≤–Ω–æ–π –∞–ø–¥–µ–π—Ç
    try{
      const r = await fetch('/.netlify/functions/crm-update',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
      });
      ok = r.ok; code = r.status;
    }catch(_){}

    // –∑–∞–ø–∞—Å–Ω–æ–π –ø—É—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ append
    if(!ok){
      try{
        const r2 = await fetch('/.netlify/functions/save-client',{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
        });
        ok = r2.ok; code = r2.status;
      }catch(_){}
    }

    if(ok){
      tr.dataset.id = data.id;
      const i = crmAll.findIndex(x=>x.id===data.id);
      if(i===-1) crmAll.unshift(data); else crmAll[i]=data;
      e.target.textContent='‚úì'; setTimeout(()=>e.target.textContent='üíæ',800);
    }else{
      alert('CRM –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ('+code+')');
    }
  });

  // DELETE
  tbody.querySelectorAll('[data-action="delete"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    if(!id){ tr.remove(); return; }
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
    try{
      const r = await fetch('/.netlify/functions/crm-delete',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})
      });
      if(r.ok){ tr.remove(); crmAll = crmAll.filter(x=>x.id!==id); }
      else alert('CRM –æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ('+r.status+')');
    }catch{ alert('CRM –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });
}

// —Ñ–æ—Ä–º–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É¬ª
document.getElementById('crm-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const payload = {
    id: Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6),
    name: f.name.value.trim(),
    phone: f.phone.value.trim(),
    email: f.email.value.trim(),
    car: f.car.value.trim(),
    date_from: f.date_from.value,
    date_to: f.date_to.value,
    status: 'new',
    comment: f.comment.value.trim()
  };
  const r = await fetch('/.netlify/functions/save-client',{
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  }).catch(()=>null);

  const status = document.getElementById('crm-status');
  if(r && r.ok){ status.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'; f.reset(); crmLoad(); }
  else{ status.textContent='–û—à–∏–±–∫–∞ CRM'; alert('–û—à–∏–±–∫–∞ CRM: '+(r?.status||'network')); }
});

// –ø–æ–∏—Å–∫/–∫–Ω–æ–ø–∫–∏
document.getElementById('crm-search')?.addEventListener('input', ()=>{
  const q = document.getElementById('crm-search').value.trim().toLowerCase();
  if(!q) return renderCRMTable(crmAll);
  const filt = crmAll.filter(r =>
    String(r.name||'').toLowerCase().includes(q) ||
    String(r.phone||'').toLowerCase().includes(q)
  );
  renderCRMTable(filt);
});
document.getElementById('crm-refresh')?.addEventListener('click', crmLoad);
document.getElementById('crm-add')?.addEventListener('click', ()=>{
  const tbody = document.querySelector('#crm-table tbody');
  const tmp = { id:'', name:'', phone:'', email:'', car:'', date_from:'', date_to:'', status:'new', comment:'' };
  tbody.insertAdjacentHTML('afterbegin', crmRowHTML(tmp));
});
document.getElementById('crm-export')?.addEventListener('click', ()=>{
  const rows = [['–ò–º—è','–¢–µ–ª–µ—Ñ–æ–Ω','Email','–ê–≤—Ç–æ','–°','–ü–æ','–°—Ç–∞—Ç—É—Å','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π']];
  (crmAll||[]).forEach(c=>rows.push([c.name,c.phone,c.email,c.car,c.date_from,c.date_to,c.status,c.comment]));
  const csv = rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='crm.csv'; a.click();
});

/* =====================================================
   BOOKING (list from /data/bookings.json, save via functions)
   ===================================================== */
const CAL_STATUSES = [
  { v:'new', t:'–ù–æ–≤–∞—è' }, { v:'hold', t:'–û–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è' },
  { v:'confirmed', t:'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞' }, { v:'done', t:'–ó–∞–≤–µ—Ä—à–µ–Ω–∞' },
  { v:'cancelled', t:'–û—Ç–º–µ–Ω–µ–Ω–∞' }
];

async function calLoad(){
  try{
    const r = await fetch('/data/bookings.json', { cache:'no-store' });
    const j = await r.json();
    const items = Array.isArray(j) ? j : (j.bookings || []);
    renderCal(items);
  }catch(e){
    console.error('calLoad', e);
    document.getElementById('bk-status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è';
  }
}

function calRowHTML(b){
  const opts = CAL_STATUSES.map(s=>`<option value="${s.v}" ${b.status===s.v?'selected':''}>${s.t}</option>`).join('');
  return `
  <tr data-id="${esc(b.id||'')}">
    <td><input value="${esc(b.name||'')}"></td>
    <td><input value="${esc(b.phone||'')}"></td>
    <td>
      <input placeholder="car_id" style="width:120px" value="${esc(b.car_id||'')}">
      <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${esc(b.car||'')}">
    </td>
    <td><input type="date" value="${d10(b.date_from)}"></td>
    <td><input type="date" value="${d10(b.date_to)}"></td>
    <td><select class="cal-status">${opts}</select></td>
    <td><input value="${esc(b.comment||'')}"></td>
    <td style="white-space:nowrap">
      <button class="btn" data-action="save">üíæ</button>
      <button class="btn" data-action="delete">üóëÔ∏è</button>
    </td>
  </tr>`;
}

function readCalRow(tr){
  const t = tr.querySelectorAll('td');
  const carInputs = t[2].querySelectorAll('input');
  return {
    id: tr.dataset.id || (Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6)),
    name: t[0].querySelector('input').value.trim(),
    phone: t[1].querySelector('input').value.trim(),
    car_id: carInputs[0].value.trim(),
    car: carInputs[1].value.trim(),
    date_from: t[3].querySelector('input').value,
    date_to: t[4].querySelector('input').value,
    status: t[5].querySelector('select').value,
    comment: t[6].querySelector('input').value.trim()
  };
}

function renderCal(items){
  const tbody = document.querySelector('#cal-table tbody');
  if(!tbody) return;
  tbody.innerHTML = items.map(calRowHTML).join('');

  // SAVE
  tbody.querySelectorAll('[data-action="save"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr');
    const data = readCalRow(tr);
    let ok=false, code=0;

    try{
      const r = await fetch('/.netlify/functions/cal-update',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
      });
      ok = r.ok; code = r.status;
    }catch(_){}

    if(!ok){
      try{
        const r2 = await fetch('/.netlify/functions/save-booking',{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
        });
        ok = r2.ok; code = r2.status;
      }catch(_){}
    }

    if(ok){
      tr.dataset.id = data.id;
      e.target.textContent='‚úì'; setTimeout(()=>e.target.textContent='üíæ',800);
    }else{
      alert('–ö–∞–ª–µ–Ω–¥–∞—Ä—å: –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ('+code+')');
    }
  });

  // DELETE
  tbody.querySelectorAll('[data-action="delete"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr'); const id = tr.dataset.id;
    if(id && !confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
    const r = id ? await fetch('/.netlify/functions/cal-delete',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})
    }).catch(()=>null) : { ok:true };
    if(r && r.ok) tr.remove(); else alert('–ö–∞–ª–µ–Ω–¥–∞—Ä—å: –æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
  });
}

document.getElementById('cal-add')?.addEventListener('click', ()=>{
  const tbody = document.querySelector('#cal-table tbody');
  const tmp = { id:'', name:'', phone:'', car_id:'', car:'', date_from:'', date_to:'', status:'new', comment:'' };
  tbody.insertAdjacentHTML('afterbegin', calRowHTML(tmp));
});

/* ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –≤–∫–ª–∞–¥–æ–∫ + –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));
      document.getElementById('tab-'+tab)?.classList.add('active');
    });
  });

  crmLoad();
  calLoad();
});
</script>

</body>
</html>

