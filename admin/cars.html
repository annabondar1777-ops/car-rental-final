<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin — Auto</title>
  <link rel="stylesheet" href="assets/css/admin.css">
</head>
<body>
<header class="header">
  <div class="brand"><img src="assets/img/logo.png" alt="Logo"></div>
  <nav class="nav">
    <div id="lang-switch" class="row">
      <button class="btn" data-lang="ru">RU</button>
      <button class="btn" data-lang="ro">RO</button>
      <button class="btn" data-lang="en">EN</button>
    </div>
    <button class="btn tab-btn" data-tab="cars">Автомобили</button>
    <button class="btn tab-btn" data-tab="crm">CRM</button>
    <button class="btn tab-btn" data-tab="booking">Календарь</button>
    <button class="btn tab-btn" data-tab="settings">Настройки</button>
    <button class="btn tab-btn" data-tab="notify">Уведомления</button>
  </nav>
</header>

<main>

<!-- ====================== CARS ====================== -->
<section id="tab-cars" class="tab active">
  <form id="car-form" class="card">
    <div class="grid2">
      <div>
        <label>Название<input name="name" placeholder="Название"></label>
        <label>Описание<textarea name="description" rows="3" placeholder="Описание авто"></textarea></label>
        <label>Год <input name="year" placeholder="2021"></label>
        <label>КПП <input name="transmission" placeholder="Automat / Manual"></label>
        <label>Топливо <input name="fuel" placeholder="Benzină / Diesel"></label>
        <label>Цена/сутки <input name="price_per_day" placeholder="100"></label>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" name="bookable" checked> Участвует в календаре
        </label>
      </div>
      <div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <input id="file-input" type="file" accept="image/*" multiple capture="environment" style="display:none">
          <button class="btn" type="button" id="btn-pick">Выбрать фото</button>
          <button class="btn" type="button" id="btn-upload">Загрузить в сайт</button>
          <span class="muted" id="upload-msg"></span>
        </div>
        <label>Фото (URL, по одной в строке)
          <textarea id="car-images" name="images" rows="8" placeholder="https://...jpg"></textarea>
        </label>
        <div id="images-preview" class="grid-img"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="car-add" type="button">Новая запись</button>
      <button class="btn primary" id="car-save" type="submit">Сохранить</button>
    </div>
  </form>

  <div class="card">
    <div class="row space">
      <h3>Список автомобилей</h3>
      <div id="publish_status" class="muted"></div>
    </div>
    <table class="table">
      <thead>
        <tr><th>Название</th><th>Год</th><th>КПП</th><th>Топливо</th><th>Цена</th><th>Статус</th><th></th></tr>
      </thead>
      <tbody id="cars-list"></tbody>
    </table>
  </div>
</section>

<!-- ====================== CRM ====================== -->
<section id="tab-crm" class="tab">
  <div class="card">
    <h3>CRM — Заявка клиента</h3>
    <form id="crm-form">
      <div class="grid2">
        <div>
          <label>Имя<input name="name" placeholder="Иван Иванов" required></label>
          <label>Телефон<input name="phone" placeholder="+373 ..." required></label>
          <label>Email<input name="email" placeholder="client@example.com"></label>
          <label>Автомобиль<input name="car" placeholder="BMW X5"></label>
        </div>
        <div>
          <label>Дата с<input name="date_from" type="date"></label>
          <label>Дата по<input name="date_to" type="date"></label>
          <label>Комментарий<textarea name="comment" rows="4" placeholder="Пожелания клиента"></textarea></label>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" type="submit">Сохранить заявку</button>
        <span class="muted" id="crm-status"></span>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="row space" style="gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Заявки</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <input id="crm-search" placeholder="Поиск: имя или телефон"
               style="width:280px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background:transparent;color:inherit">
        <button id="crm-refresh" class="btn" type="button">Обновить</button>
        <button id="crm-add" class="btn" type="button">Новая заявка</button>
        <button id="crm-export" class="btn" type="button">Экспорт CSV</button>
      </div>
    </div>

    <table id="crm-table" class="table" style="width:100%">
      <thead>
        <tr>
          <th>Имя</th><th>Телефон</th><th>Email</th><th>Авто</th>
          <th>С</th><th>По</th><th>Статус</th><th>Комментарий</th><th>Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- ====================== BOOKING (Calendar admin) ====================== -->
<section id="tab-booking" class="tab">
  <div class="card">
    <div class="row space" style="gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Календарь занятости</h3>
      <button id="cal-add" class="btn primary" type="button">Новая запись</button>
      <span class="muted" id="bk-status"></span>
    </div>

    <table id="cal-table" class="table" style="width:100%">
      <thead>
        <tr>
          <th>Имя</th>
          <th>Телефон</th>
          <th>Авто (ID/Название)</th>
          <th>С</th>
          <th>По</th>
          <th>Статус</th>
          <th>Комментарий</th>
          <th style="white-space:nowrap">Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- ====================== SETTINGS ====================== -->
<section id="tab-settings" class="tab">
  <div class="card">
    <h3>Настройки сайта</h3>
    <form id="settings-form">
      <div class="grid2">
        <div>
          <label>Бренд<input name="brand" placeholder="Auto Rent"></label>
          <label>Слоган (RO)<input name="slogan_ro" placeholder="chirii auto"></label>
          <label>Слоган (RU)<input name="slogan_ru" placeholder="прокат авто"></label>
          <label>Слоган (EN)<input name="slogan_en" placeholder="car rental"></label>
        </div>
        <div>
          <label>Телефон основной<input name="phone_main" placeholder="+373 ..."></label>
          <label>Телефон доп.<input name="phone_alt" placeholder="+373 ..."></label>
          <label>Instagram<input name="instagram_link" placeholder="https://instagram.com/..."></label>
          <label>WhatsApp<input name="whatsapp_link" placeholder="https://wa.me/373..."></label>
          <label>Telegram<input name="telegram_link" placeholder="https://t.me/..."></label>
          <label>Viber<input name="viber_link" placeholder="viber://chat?number=+373..."></label>
          <label>Email<input name="email" placeholder="info@example.com"></label>
          <label>Адрес<input name="address" placeholder="str. ..."></label>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" id="settings-save" type="submit">Сохранить настройки</button>
        <span class="muted" id="settings-status"></span>
      </div>
    </form>
  </div>
</section>

<!-- ====================== NOTIFY ====================== -->
<section id="tab-notify" class="tab">
  <div class="card">
    <h3>Уведомления</h3>
    <form id="notify-form">
      <div class="grid2">
        <div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" name="email_enabled" checked> Отправлять на email
          </label>
          <label>Email для уведомлений
            <input name="email_to" placeholder="you@example.com" value="paulacerniciuc@gmail.com">
          </label>
        </div>
        <div class="muted">
          Письма приходят при новых заявках и бронях. 
          На Netlify добавьте переменные: <b>RESEND_API_KEY</b>, <b>ADMIN_EMAIL</b>, <b>SITE_URL</b>.
        </div>
      </div>
      <div class="row">
        <button class="btn primary" type="submit">Сохранить уведомления</button>
        <span class="muted" id="notify-status"></span>
      </div>
    </form>
  </div>
</section>

</main>

<script src="assets/js/admin.js"></script>

<script>
/* ===== helpers ===== */
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
const d10 = s => { if(!s) return ''; const d=new Date(s); return isNaN(+d)?String(s).slice(0,10):d.toISOString().slice(0,10); };

/* =====================================================
   CRM (list from /data/clients.json, save via functions)
   ===================================================== */
const CRM_STATUSES = [
  { v:'new', t:'Новая' }, { v:'in_progress', t:'В работе' },
  { v:'confirmed', t:'Подтверждена' }, { v:'cancelled', t:'Отменена' }, { v:'done', t:'Завершена' }
];

let crmAll = [];

async function crmLoad(){
  try{
    // читаем напрямую JSON в репозитории
    const r = await fetch('/data/clients.json', { cache: 'no-store' });
    const j = await r.json();
    crmAll = Array.isArray(j) ? j : (j.clients || []);
    renderCRMTable(crmAll);
  }catch(e){
    console.error('crmLoad', e);
    document.querySelector('#crm-status').textContent = 'Ошибка загрузки CRM';
  }
}

function crmRowHTML(c){
  const opts = CRM_STATUSES.map(s => `<option value="${s.v}" ${c.status===s.v?'selected':''}>${s.t}</option>`).join('');
  return `
    <tr data-id="${esc(c.id||'')}">
      <td><input value="${esc(c.name||'')}"></td>
      <td><input value="${esc(c.phone||'')}"></td>
      <td><input value="${esc(c.email||'')}"></td>
      <td><input value="${esc(c.cars||c.car||'')}"></td>
      <td><input type="date" value="${d10(c.date_from)}"></td>
      <td><input type="date" value="${d10(c.date_to)}"></td>
      <td><select class="crm-status">${opts}</select></td>
      <td><input value="${esc(c.comment||'')}"></td>
      <td style="white-space:nowrap">
        <button class="btn" data-action="save">💾</button>
        <button class="btn" data-action="delete">🗑️</button>
      </td>
    </tr>`;
}

function readCrmRow(tr){
  const t=tr.querySelectorAll('td');
  return {
    id: tr.dataset.id || (Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6)),
    name: t[0].querySelector('input').value.trim(),
    phone: t[1].querySelector('input').value.trim(),
    email: t[2].querySelector('input').value.trim(),
    car: t[3].querySelector('input').value.trim(),
    date_from: t[4].querySelector('input').value,
    date_to: t[5].querySelector('input').value,
    status: t[6].querySelector('select').value,
    comment: t[7].querySelector('input').value.trim()
  };
}

function renderCRMTable(items){
  const tbody = document.querySelector('#crm-table tbody');
  if(!tbody) return;
  tbody.innerHTML = items.map(crmRowHTML).join('');

  // SAVE
  tbody.querySelectorAll('[data-action="save"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr');
    const data = readCrmRow(tr);
    let ok=false, code=0;

    // основной апдейт
    try{
      const r = await fetch('/.netlify/functions/crm-update',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
      });
      ok = r.ok; code = r.status;
    }catch(_){}

    // запасной путь — просто append
    if(!ok){
      try{
        const r2 = await fetch('/.netlify/functions/save-client',{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
        });
        ok = r2.ok; code = r2.status;
      }catch(_){}
    }

    if(ok){
      tr.dataset.id = data.id;
      const i = crmAll.findIndex(x=>x.id===data.id);
      if(i===-1) crmAll.unshift(data); else crmAll[i]=data;
      e.target.textContent='✓'; setTimeout(()=>e.target.textContent='💾',800);
    }else{
      alert('CRM ошибка сохранения ('+code+')');
    }
  });

  // DELETE
  tbody.querySelectorAll('[data-action="delete"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr');
    const id = tr.dataset.id;
    if(!id){ tr.remove(); return; }
    if(!confirm('Удалить заявку?')) return;
    try{
      const r = await fetch('/.netlify/functions/crm-delete',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})
      });
      if(r.ok){ tr.remove(); crmAll = crmAll.filter(x=>x.id!==id); }
      else alert('CRM ошибка удаления ('+r.status+')');
    }catch{ alert('CRM ошибка сети'); }
  });
}

// форма «Сохранить заявку»
document.getElementById('crm-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const payload = {
    id: Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6),
    name: f.name.value.trim(),
    phone: f.phone.value.trim(),
    email: f.email.value.trim(),
    car: f.car.value.trim(),
    date_from: f.date_from.value,
    date_to: f.date_to.value,
    status: 'new',
    comment: f.comment.value.trim()
  };
  const r = await fetch('/.netlify/functions/save-client',{
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  }).catch(()=>null);

  const status = document.getElementById('crm-status');
  if(r && r.ok){ status.textContent='Сохранено и отправлено'; f.reset(); crmLoad(); }
  else{ status.textContent='Ошибка CRM'; alert('Ошибка CRM: '+(r?.status||'network')); }
});

// поиск/кнопки
document.getElementById('crm-search')?.addEventListener('input', ()=>{
  const q = document.getElementById('crm-search').value.trim().toLowerCase();
  if(!q) return renderCRMTable(crmAll);
  const filt = crmAll.filter(r =>
    String(r.name||'').toLowerCase().includes(q) ||
    String(r.phone||'').toLowerCase().includes(q)
  );
  renderCRMTable(filt);
});
document.getElementById('crm-refresh')?.addEventListener('click', crmLoad);
document.getElementById('crm-add')?.addEventListener('click', ()=>{
  const tbody = document.querySelector('#crm-table tbody');
  const tmp = { id:'', name:'', phone:'', email:'', car:'', date_from:'', date_to:'', status:'new', comment:'' };
  tbody.insertAdjacentHTML('afterbegin', crmRowHTML(tmp));
});
document.getElementById('crm-export')?.addEventListener('click', ()=>{
  const rows = [['Имя','Телефон','Email','Авто','С','По','Статус','Комментарий']];
  (crmAll||[]).forEach(c=>rows.push([c.name,c.phone,c.email,c.car,c.date_from,c.date_to,c.status,c.comment]));
  const csv = rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='crm.csv'; a.click();
});

/* =====================================================
   BOOKING (list from /data/bookings.json, save via functions)
   ===================================================== */
const CAL_STATUSES = [
  { v:'new', t:'Новая' }, { v:'hold', t:'Оплачивается' },
  { v:'confirmed', t:'Подтверждена' }, { v:'done', t:'Завершена' },
  { v:'cancelled', t:'Отменена' }
];

async function calLoad(){
  try{
    const r = await fetch('/data/bookings.json', { cache:'no-store' });
    const j = await r.json();
    const items = Array.isArray(j) ? j : (j.bookings || []);
    renderCal(items);
  }catch(e){
    console.error('calLoad', e);
    document.getElementById('bk-status').textContent = 'Ошибка загрузки календаря';
  }
}

function calRowHTML(b){
  const opts = CAL_STATUSES.map(s=>`<option value="${s.v}" ${b.status===s.v?'selected':''}>${s.t}</option>`).join('');
  return `
  <tr data-id="${esc(b.id||'')}">
    <td><input value="${esc(b.name||'')}"></td>
    <td><input value="${esc(b.phone||'')}"></td>
    <td>
      <input placeholder="car_id" style="width:120px" value="${esc(b.car_id||'')}">
      <input placeholder="Название" value="${esc(b.car||'')}">
    </td>
    <td><input type="date" value="${d10(b.date_from)}"></td>
    <td><input type="date" value="${d10(b.date_to)}"></td>
    <td><select class="cal-status">${opts}</select></td>
    <td><input value="${esc(b.comment||'')}"></td>
    <td style="white-space:nowrap">
      <button class="btn" data-action="save">💾</button>
      <button class="btn" data-action="delete">🗑️</button>
    </td>
  </tr>`;
}

function readCalRow(tr){
  const t = tr.querySelectorAll('td');
  const carInputs = t[2].querySelectorAll('input');
  return {
    id: tr.dataset.id || (Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6)),
    name: t[0].querySelector('input').value.trim(),
    phone: t[1].querySelector('input').value.trim(),
    car_id: carInputs[0].value.trim(),
    car: carInputs[1].value.trim(),
    date_from: t[3].querySelector('input').value,
    date_to: t[4].querySelector('input').value,
    status: t[5].querySelector('select').value,
    comment: t[6].querySelector('input').value.trim()
  };
}

function renderCal(items){
  const tbody = document.querySelector('#cal-table tbody');
  if(!tbody) return;
  tbody.innerHTML = items.map(calRowHTML).join('');

  // SAVE
  tbody.querySelectorAll('[data-action="save"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr');
    const data = readCalRow(tr);
    let ok=false, code=0;

    try{
      const r = await fetch('/.netlify/functions/cal-update',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
      });
      ok = r.ok; code = r.status;
    }catch(_){}

    if(!ok){
      try{
        const r2 = await fetch('/.netlify/functions/save-booking',{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
        });
        ok = r2.ok; code = r2.status;
      }catch(_){}
    }

    if(ok){
      tr.dataset.id = data.id;
      e.target.textContent='✓'; setTimeout(()=>e.target.textContent='💾',800);
    }else{
      alert('Календарь: ошибка сохранения ('+code+')');
    }
  });

  // DELETE
  tbody.querySelectorAll('[data-action="delete"]').forEach(b=>b.onclick = async (e)=>{
    const tr = e.target.closest('tr'); const id = tr.dataset.id;
    if(id && !confirm('Удалить запись?')) return;
    const r = id ? await fetch('/.netlify/functions/cal-delete',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})
    }).catch(()=>null) : { ok:true };
    if(r && r.ok) tr.remove(); else alert('Календарь: ошибка удаления');
  });
}

document.getElementById('cal-add')?.addEventListener('click', ()=>{
  const tbody = document.querySelector('#cal-table tbody');
  const tmp = { id:'', name:'', phone:'', car_id:'', car:'', date_from:'', date_to:'', status:'new', comment:'' };
  tbody.insertAdjacentHTML('afterbegin', calRowHTML(tmp));
});

/* ===== ИНИЦИАЛИЗАЦИЯ вкладок + первичная загрузка ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));
      document.getElementById('tab-'+tab)?.classList.add('active');
    });
  });

  crmLoad();
  calLoad();
});
</script>

</body>
</html>

